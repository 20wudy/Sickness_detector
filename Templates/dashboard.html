{% extends "base.html" %}

{% block content %}
<h1>Your Health Dashboard</h1>

<div class="data-entry">
    <form action="/dashboard" method="post">
        <input type="hidden" name="user_id" value="{{ request.args.get('user_id', 'default_user') }}">
        <h3>Add Today's Data</h3>
        <div class="form-group">
            <label>Avg HR: <input typae="number" name="avg_hr" required></label>
            <label>Min HR: <input type="number" name="min_hr" required></label>
            <label>Max HR: <input type="number" name="max_hr" required></label>
        </div>
        <div class="form-group">
            <label>Sleep Hours: <input type="number" step="0.1" name="sleep_hours" required></label>
            <label>Sleep Quality: <input type="number" name="sleep_quality" min="0" max="100" value="80"></label>
        </div>
        <button type="submit">Submit</button>
    </form>
</div>

{% if analysis.status == 'insufficient_data' %}
<div class="alert">
    Need {{ analysis.required_days }} days of data (currently {{ analysis.current_days }}).
    Check back tomorrow!
</div>
{% else %}
<div class="analysis">
    <h3>Latest Analysis</h3>
    <p>Avg HR: {{ analysis.latest_data.avg_hr }} 
       (14-day avg: {{ "%.1f"|format(analysis.latest_data.hr_14day_avg|float) }})</p>
    <p>Sleep: {{ analysis.latest_data.sleep_hours }}h
       (14-day avg: {{ "%.1f"|format(analysis.latest_data.sleep_14day_avg|float) }}h)</p>
    {% if analysis.latest_data.is_anomaly %}
    <div class="alert warning">Abnormal pattern detected! Please take care of yourself to prevent sickness!</div>
    {% endif %}
</div>

<div class="charts">
    <div class="chart-container">
        <canvas id="hrChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="sleepChart"></canvas>
    </div>
</div>

<script>
    // Safely parse the JSON data
    const chartData = JSON.parse('{{ analysis.chart_data|tojson|safe }}');
    
    // Format dates for display
    const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    };

    // HR Chart
    new Chart(
        document.getElementById('hrChart'),
        {
            type: 'line',
            data: {
                labels: chartData.map(d => formatDate(d.date)),
                datasets: [
                    {
                        label: 'Avg HR (bpm)',
                        data: chartData.map(d => d.avg_hr),
                        borderColor: '#ff6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: '14-day Avg',
                        data: chartData.map(d => d.hr_14day_avg),
                        borderColor: '#cc0000',
                        borderDash: [5, 5],
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Heart Rate Trends'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Beats per minute'
                        }
                    }
                }
            }
        }
    );

    // Sleep Chart
    new Chart(
        document.getElementById('sleepChart'),
        {
            type: 'line',
            data: {
                labels: chartData.map(d => formatDate(d.date)),
                datasets: [
                    {
                        label: 'Sleep Hours',
                        data: chartData.map(d => d.sleep_hours),
                        borderColor: '#36a2eb',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: '14-day Avg',
                        data: chartData.map(d => d.sleep_14day_avg),
                        borderColor: '#1a75ff',
                        borderDash: [5, 5],
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Sleep Duration Trends'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Hours'
                        }
                    }
                }
            }
        }
    );
</script>
{% endif %}
{% endblock %}